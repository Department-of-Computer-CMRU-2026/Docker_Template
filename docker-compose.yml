services:
  # 1. Laravel Application
  app:
    build:
      args:
        user: smartclass
        uid: 1000
      context: .
      dockerfile: Dockerfile
    image: ${STUDENT_NAME}-smartclass-app
    container_name: ${STUDENT_NAME}-smartclass-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
      - /var/www/vendor # ป้องกันไม่ให้ Volume หลักทับ Vendor ที่ build มา
      - storage-data:/var/www/storage/app/public # [NEW] Persist uploads
      - /proc:/host/proc:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - TZ=Asia/Bangkok
      - DB_HOST=${STUDENT_NAME}-smartclass-db
      - REDIS_HOST=${STUDENT_NAME}-smartclass-redis
    networks:
      - app-network # ใช้ชื่อ Key ตายตัว
    depends_on:
      - db
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 2. Nginx Web Server
  nginx:
    image: nginx:alpine
    container_name: ${STUDENT_NAME}-smartclass-nginx
    restart: unless-stopped
    ports:
      - "${STUDENT_PORT}:80"
    volumes:
      - ./:/var/www
      - ./docker/nginx:/etc/nginx/conf.d/
      - storage-data:/var/www/storage/app/public # [NEW] Share uploads with Nginx
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - TZ=Asia/Bangkok
    networks:
      - app-network
    depends_on:
      - app
    deploy:
      resources:
        limits:
          cpus: '0.20'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 3. PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: ${STUDENT_NAME}-smartclass-db
    restart: unless-stopped
    ports:
      - "${FORWARD_DB_PORT:-5432}:5432"
    environment:
      - TZ=Asia/Bangkok
      - POSTGRES_DB=${DB_DATABASE:-smart_class}
      - POSTGRES_USER=${DB_USERNAME:-smartclass}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-secret}
    volumes:
      - db-data:/var/lib/postgresql/data # ใช้ชื่อ Key ตายตัว
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# --- จุดที่ต้องแก้ไขให้ถูกต้อง (หัวใจของ Error) ---
networks:
  app-network:
    name: "${STUDENT_NAME}-smartclass-net" # กำหนดชื่อจริงผ่าน Property name

volumes:
  db-data:
    name: "${STUDENT_NAME}-smartclass-db-data" # กำหนดชื่อจริงผ่าน Property name
  storage-data:
    name: "${STUDENT_NAME}-smartclass-storage-data" # [NEW] Named volume for uploads